"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _alloyfinger=_interopRequireDefault(require("alloyfinger"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function _classCallCheck(e,t){if(!_instanceof(e,t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var preview=function(){function e(t){_classCallCheck(this,e),_defineProperty(this,"$onEvent",{left:function(){return 0},right:function(){return 0},up:function(){return 0},down:function(){return 0},leave:function(){return 0},close:function(){return 0}}),this.previewDom=null,this.previewCardDom=null,this.previewMaskDom=null,this.previewImageDom=null,this.finger=null,this.isSingle=!t||!t.mode||"single"===t.mode,this.close=this.close.bind(this),this.thumb={},this.originY=null,this.currentMove=0,this.innerWidth=0,this.startX=this.startY=this.scaleStartX=this.scaleStartY=null,this.isMoving=!1,this.leaveHight=200,this.type="",this.fingerNum=1,this.firstTouch="",this.timeoutId="",this.initialPinchLength="",this.initialBoundingRect="",this.currentPinchLength="",this.config={scale:1,translateX:0,translateY:0,maxScale:3,minScale:1,transitionDuration:400},this.isSingle||t.imgList&&0!==t.imgList.length?(this.isSingle&&this.initDom(t&&t.target),this.isSingle||(this.imgList=t.imgList,this.initDom())):console.log("缺少imgList参数")}return _createClass(e,[{key:"$on",value:function(e,t){this.$onEvent[e]=t}},{key:"initDom",value:function(){var e=this;if(!document.querySelector(".preview")){var t=document.querySelector("body");this.innerWidth=window.innerWidth;var i,n="";this.isSingle?n='\n        <div class="preview-card">\n          <div class=\'preview-image\'><img style="width:'.concat(this.innerWidth,'px"></div>\n        </div>\n        <div class="preview-mask"></div> \n      '):(n='<div class="preview-list" style="width:'.concat(this.imgList.length*this.innerWidth+30,'px">'),this.imgList.forEach(function(t){n+="\n        <div class='preview-card' style=\"width:".concat(e.innerWidth,"px\">\n          <div class='preview-image'>\n            <img src='").concat(t,"' style=\"width:").concat(e.innerWidth,'px">\n          </div>\n        </div>')}),n+="</div><div class='preview-mask'></div>"),(i=document.createElement("div")).classList.add("preview"),i.innerHTML=n,t.appendChild(i),this.previewDom=document.querySelector(".preview"),this.previewListDom=document.querySelector(".preview-list")||"",this.previewMaskDom=document.querySelector(".preview-mask"),this.cardImageDom=this.isSingle?"":document.querySelectorAll(".card-image img"),this.previewCardDomAll=this.isSingle?"":document.querySelectorAll(".preview-card"),this.previewImageDomAll=document.querySelectorAll(".preview-card img"),this.previewCardDom=this.isSingle?document.querySelector(".preview-card"):document.querySelectorAll(".preview-card")[0],this.previewImageDom=this.isSingle?document.querySelector(".preview-image img"):document.querySelectorAll(".preview-card img")[0]}}},{key:"initFinger",value:function(){var e=this;this.finger=new _alloyfinger.default(this.previewDom,{touchStart:function(t){var i=t.touches.length;1===i&&(e.fingerNum=1,e.startX=t.touches[0].pageX,e.startY=t.touches[0].pageY),2===i&&e.isMoving?e.fingerNum=2:(2!==i||e.scaleStartX||(e.fingerNum=2,e.doublePointStart(t)),2===i&&e.scaleStartX&&(e.fingerNum=2))},touchMove:function(t){var i=t.touches.length;!e.firstTouch||2!==i||e.caleStartX?e.firstTouch&&1===i&&e.scaleStartX?e.scalePointMove(t):e.firstTouch&&1===i&&!e.scaleStartX||1===e.fingerNum&&1===i&&(t.preventDefault(),e.isMoving=!0,e.singlePointMove(t)):e.doublePointMove(t)},touchEnd:function(t){if(2===e.fingerNum&&e.firstTouch){if(e.fingerNum--,e.scaleStartX)return;var i=t.touches||t.targetTouches;i.length>=1&&i[0].pageX?(e.scaleStartX=i[0].pageX,e.scaleStartY=i[0].pageY):(e.doublePointEnd(t),e.fingerNum--)}else{if(1!==e.fingerNum||!e.firstTouch)return 1===e.fingerNum&&e.isMoving?(e.singlePointEnd(t),e.isMoving=!1,void(e.type="")):void e.fingerNum--;e.doublePointEnd(t)}}})}},{key:"open",value:async function(e){if(!this.isSingle||e.url){if(this.isSingle)this.previewImageDom.src=e.url||"";else{var t="".concat((e.index-1)*-(this.innerWidth+30));this.previewCardDom=this.previewCardDomAll[e.index-1],this.previewImageDom=this.previewImageDomAll[e.index-1],this.previewListDom.style.left="".concat(t,"px"),this.currentMove=Number(t)}if(e.target||e.index){var i=e.target||document.querySelectorAll(".card-image img")[e.index-1];this.getDomRect(i)}this.finger||this.initFinger(),this.previewDom.classList.add("is-show"),this.setCardTransform({x:this.thumb.x,y:this.thumb.y,zoom:this.thumb.zoom}),await this.sleep(50),this.previewDom.classList.add("is-fade-in-mask"),this.setCardTransform({x:0,y:this.isSingle?this.originY:0,zoom:1}),document.querySelector(".preview-mask").addEventListener("click",this.close)}}},{key:"close",value:async function(e){e&&(this.previewDom.classList.remove("is-moving"),this.previewMaskDom.style.opacity=0),this.previewDom.classList.remove("is-fade-in-mask"),this.setCardTransform({x:this.thumb.x,y:this.thumb.y,zoom:this.thumb.zoom}),await this.sleep(500),this.previewDom.classList.remove("is-show"),this.previewMaskDom.removeEventListener("click",this.close),this.isSingle||(this.previewCardDom.style.transform=""),e&&(this.previewMaskDom.style.opacity=null,this.previewCardDom.style.transform="")}},{key:"setCardTransform",value:function(e){this.previewCardDom.style.transform="translate3d(".concat(e.x,"px, ").concat(e.y,"px, 0px)")+"scale(".concat(e.zoom,")")}},{key:"getLengthOfLine",value:function(e,t){var i=t.clientX,n=e.clientY,s=Math.abs(i-e.clientX),r=Math.abs(n-t.clientY);return Math.sqrt(s*s+r*r)}},{key:"getMiddleOfLine",value:function(e,t){return{clientX:Math.min(t.clientX,e.clientX)+Math.abs(t.clientX-e.clientX)/2,clientY:Math.min(t.clientY,e.clientY)+Math.abs(t.clientY-e.clientY)/2}}},{key:"getMiddleTouchOnElement",value:function(e,t){var i=this.getMiddleOfLine(e[0],e[1]);return{clientX:i.clientX-t.left,clientY:i.clientY-t.top}}},{key:"isTouchesInsideRect",value:function(e,t){return Array.prototype.every.call(e,function(e){return e.clientX<=t.right&&e.clientX>=t.left&&e.clientY<=t.bottom&&e.clientY>=t.top})}},{key:"setTransitionDuration",value:function(e){this.previewImageDom.style.transitionDuration="".concat(e,"ms")}},{key:"setTransform",value:function(e,t,i){e=(e=e<this.config.minScale?this.config.minScale:e)>this.config.maxScale?this.config.maxScale:e,this.previewImageDom.style.transform="translate3d(".concat(t,"px, ").concat(i,"px, 0)")+"scale3d(".concat(e,", ").concat(e,", 1)")}},{key:"setTransformOrigin",value:function(e,t){this.previewImageDom.style.transformOrigin="".concat(e," ").concat(t," 0")}},{key:"resetProperties",value:function(){this.firstTouch=null,this.initialPinchLength=null,this.currentPinchLength=null,this.initialBoundingRect=null,this.scaleStartX=null,this.scaleStartY=null}},{key:"doublePointStart",value:function(e){if(this.initialBoundingRect=this.previewImageDom.getBoundingClientRect(),e.touches.length&&this.isTouchesInsideRect(e.touches,this.initialBoundingRect)){e.preventDefault(),this.setTransitionDuration(0);var t=e.touches[0],i=e.touches[1],n=this.getMiddleTouchOnElement(e.touches,this.initialBoundingRect);this.initialPinchLength=this.getLengthOfLine(t,i),this.setTransformOrigin("".concat(n.clientX,"px"),"".concat(n.clientY,"px")),this.firstTouch=n}}},{key:"doublePointMove",value:function(e){var t=this.getMiddleTouchOnElement(e.touches,this.initialBoundingRect);this.currentPinchLength=this.getLengthOfLine(e.touches[0],e.touches[1]);var i=this.currentPinchLength/this.initialPinchLength,n=t.clientX-this.firstTouch.clientX,s=t.clientY-this.firstTouch.clientY;this.config.scale=i,this.config.translateX=n,this.config.translateY=s,this.setTransform(i,n,s),this.config.onScale&&this.config.onScale(i,n,s)}},{key:"doublePointEnd",value:function(e){var t=this;this.setTransitionDuration(this.config.transitionDuration),this.setTransform(1,0,0),clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(function(){t.setTransitionDuration(0),t.setTransformOrigin("50%","50%")},this.config.transitionDuration),this.resetProperties()}},{key:"singlePointMove",value:function(e){var t=e.changedTouches[0].pageX,i=e.changedTouches[0].pageY,n=t-this.startX,s=i-this.startY;if("turn"===this.type||!this.type&&Math.abs(n)>Math.abs(s)){if(this.type="turn",!this.isSingle){var r=this.innerWidth/window.innerWidth;return void(document.querySelector(".preview-list").style.left="".concat(this.currentMove+n/r,"px"))}n>0?this.$onEvent.left():this.$onEvent.right()}else if("leave"===this.type||!this.type&&Math.abs(s)>Math.abs(n)){this.type="leave";var o=this.isSingle?this.originY+s:0+s,a=this.previewDom.offsetHeight/2,l=Math.abs(s)/a;this.previewDom.classList.add("is-moving"),this.previewCardDom.style.transform="translate3d(0px, ".concat(o,"px, 0px) scale(1)"),this.previewMaskDom.style.opacity=1-l}}},{key:"singlePointEnd",value:async function(e){var t=e.changedTouches[0].pageY;"turn"!==this.type?t-this.startY>this.leaveHight||t-this.startY<-this.leaveHight?this.close(!0):(this.previewDom.classList.remove("is-moving"),this.previewCardDom.style.transform="translate3d(0px, ".concat(this.isSingle?this.originY:0,"px, 0px) scale(1)"),this.previewMaskDom.style.opacity=1):this.isSingle||(this.resetPreviewListPosition(),this.currentMove=Number(this.previewListDom.style.left.split("px")[0]))}},{key:"scalePointMove",value:function(e){var t=e.changedTouches[0].pageX,i=e.changedTouches[0].pageY,n=t-this.scaleStartX,s=i-this.scaleStartY,r=this.config.scale,o=this.config.translateX+n,a=this.config.translateY+s;this.setTransform(r,o,a)}},{key:"resetPreviewListPosition",value:function(){var e=this;this.previewCardDom.style.transform="";var t=Number(this.previewListDom.style.left.split("px")[0]),i=Math.round(t/-(this.innerWidth+30));i>=this.imgList.length&&(i=this.imgList.length-1),i<0&&(i=0),this.previewListDom.style.left="".concat(-(this.innerWidth+30)*i,"px"),this.previewListDom.style.transition="all .2s",this.previewCardDom=this.previewCardDomAll[i],this.previewImageDom=this.previewImageDomAll[i],this.getDomRect(this.cardImageDom[i]),setTimeout(function(){e.previewListDom.style.transition="none"},200)}},{key:"getDomRect",value:function(e){var t=e.getBoundingClientRect(),i=t.width/document.documentElement.clientWidth;this.originY=(document.documentElement.clientHeight-t.height/i)/2,this.thumb={x:t.left,y:this.isSingle?t.top:t.top-this.originY,w:t.width,h:t.height,zoom:i}}},{key:"sleep",value:function(e){return new Promise(function(t){return setTimeout(t,e)})}},{key:"destory",value:function(){}}]),e}(),_default=preview;exports.default=_default;